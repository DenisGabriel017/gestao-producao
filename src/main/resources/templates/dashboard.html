<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gestão de Produção | Dashboard</title>

    <link rel="stylesheet" th:href="@{https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css}">
    <link rel="stylesheet" th:href="@{https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.2.0/css/adminlte.min.css}">
    <style>
        /* CSS para garantir que a página ocupe 100% da tela */
        html, body {
            height: 100%;
        }
        .wrapper {
            min-height: 100%;
            display: flex;
            flex-direction: column;
        }
        .content-wrapper {
            flex-grow: 1;
        }
        .main-footer {
            flex-shrink: 0;
        }
        /* Correção para o canvas do gráfico */
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }
    </style>
</head>
<body class="hold-transition sidebar-mini">
<div class="wrapper">

    <nav th:replace="~{fragments :: header}"></nav>
    <aside th:replace="~{fragments :: sidebar}"></aside>

    <div class="content-wrapper">
        <section class="content-header">
            <div class="container-fluid">
                <h1>Dashboard</h1>
            </div>
        </section>

        <section class="content">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-md-12">
                        <div class="card card-primary card-outline">
                            <div class="card-header">
                                <h3 class="card-title">Relatório Consolidado</h3>
                                <div class="card-tools d-flex">
                                    <select class="form-control mr-2" id="yearFilter">
                                        <option value="Todos">Todos</option>
                                    </select>
                                    <select class="form-control mr-2" id="monthFilter">
                                        <option value="Todos">Todos</option>
                                    </select>
                                    <select class="form-control" id="sectorFilter" style="display: none;">
                                        <option value="Todos">Todos</option>
                                        <option th:each="sector : ${sectors}" th:value="${sector.name}" th:text="${sector.name}"></option>
                                    </select>
                                </div>
                            </div>
                            <div class="card-body" style="position: relative;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="info-box bg-gradient-success">
                                            <span class="info-box-icon"><i class="fas fa-cubes"></i></span>
                                            <div class="info-box-content">
                                                <span class="info-box-text">Produção Total</span>
                                                <span class="info-box-number" id="totalProduction">0</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="info-box bg-gradient-danger">
                                            <span class="info-box-icon"><i class="fas fa-exchange-alt"></i></span>
                                            <div class="info-box-content">
                                                <span class="info-box-text">Gap %</span>
                                                <span class="info-box-number" id="gapPercentage">0%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="chart-container">
                                    <canvas id="reportChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <footer th:replace="~{fragments :: footer}"></footer>
    <div th:replace="~{fragments :: scripts}"></div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        var myChart;
        var yearFilter = document.getElementById('yearFilter');
        var monthFilter = document.getElementById('monthFilter');
        var sectorFilter = document.getElementById('sectorFilter');

        function populateYearFilter() {
            fetch('/api/years')
                .then(response => response.json())
                .then(years => {
                    years.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        yearFilter.appendChild(option);
                    });
                })
                .catch(error => console.error('Erro ao buscar anos:', error));
        }

        function populateMonthFilter() {
            monthFilter.innerHTML = '<option value="Todos">Todos</option>';
            const months = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            const selectedYear = yearFilter.value;

            if (selectedYear !== 'Todos') {
                for (let i = 0; i < 12; i++) {
                    const option = document.createElement('option');
                    option.value = selectedYear + '-' + String(i + 1).padStart(2, '0');
                    option.textContent = months[i];
                    monthFilter.appendChild(option);
                }
            }
        }

        function fetchAndRenderChart() {
            const year = yearFilter.value === 'Todos' ? null : yearFilter.value;
            const month = monthFilter.value === 'Todos' ? null : monthFilter.value;

            let url = '/api/chart-data?';
            const params = [];

            if (year) {
                params.push('year=' + encodeURIComponent(year));
            }
            if (month) {
                params.push('month=' + encodeURIComponent(month));
            }

            url += params.join('&');

            fetch(url)
                .then(response => response.json())
                .then(reportData => {
                    document.getElementById('totalProduction').textContent = reportData.totalProduction.toFixed(2) + ' Kg';
                    document.getElementById('gapPercentage').textContent = reportData.gapPercentage + '%';

                    if (myChart) {
                        myChart.destroy();
                    }

                    const ctx = document.getElementById('reportChart').getContext('2d');
                    myChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['Produção', 'Saída', 'Gap'],
                            datasets: [{
                                label: 'Desempenho Geral',
                                backgroundColor: ['#28a745', '#dc3545', '#ffc107'],
                                data: [reportData.totalProduction, reportData.totalOutput, reportData.gap]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    grid: {
                                        display: false
                                    }
                                },
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                })
                .catch(error => console.error('Erro ao buscar dados do gráfico:', error));
        }

        populateYearFilter();
        populateMonthFilter();

        yearFilter.addEventListener('change', () => {
            populateMonthFilter();
            fetchAndRenderChart();
        });
        monthFilter.addEventListener('change', fetchAndRenderChart);

        window.onload = fetchAndRenderChart;
    </script>
</div>
</body>
</html>