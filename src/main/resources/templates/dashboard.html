<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gestão de Produção | Dashboard</title>

    <link rel="stylesheet" th:href="@{https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css}">
    <link rel="stylesheet" th:href="@{https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.2.0/css/adminlte.min.css}">
    <script th:src="@{https://cdn.jsdelivr.net/npm/chart.js}"></script>
</head>
<body class="hold-transition sidebar-mini">
<div class="wrapper">

    <nav th:replace="~{fragments :: header}"></nav>
    <aside th:replace="~{fragments :: sidebar}"></aside>

    <div class="content-wrapper">
        <section class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1>Dashboard</h1>
                    </div>
                </div>
            </div>
        </section>

        <section class="content">
            <div class="container-fluid">

                <!-- Filtros -->
                <div class="card card-primary card-outline">
                    <div class="card-header">
                        <h3 class="card-title">Filtros</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-5">
                                <div class="form-group">
                                    <label for="year-filter">Ano</label>
                                    <select id="year-filter" class="form-control"></select>
                                </div>
                            </div>
                            <div class="col-md-5">
                                <div class="form-group">
                                    <label for="month-filter">Mês</label>
                                    <select id="month-filter" class="form-control">
                                        <option value="">Todo o ano</option>
                                        <!-- Meses são preenchidos via JS -->
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button id="filter-btn" class="btn btn-primary btn-block"><i class="fas fa-search"></i> Filtrar</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Info Boxes -->
                <div class="row">
                    <div class="col-12 col-sm-6 col-md-3">
                        <div class="info-box">
                            <span class="info-box-icon bg-info elevation-1"><i class="fas fa-industry"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">Total Produzido (Kg)</span>
                                <span class="info-box-number" id="total-production">0.00</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-md-3">
                        <div class="info-box mb-3">
                            <span class="info-box-icon bg-success elevation-1"><i class="fas fa-shopping-cart"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">Total de Vendas</span>
                                <span class="info-box-number" id="total-sales">0.00</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-md-3">
                        <div class="info-box mb-3">
                            <span class="info-box-icon bg-danger elevation-1"><i class="fas fa-trash-alt"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">Total Descartado</span>
                                <span class="info-box-number" id="total-discard">0.00</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-md-3">
                        <div class="info-box mb-3">
                            <span class="info-box-icon bg-warning elevation-1"><i class="fas fa-exclamation-triangle"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">GAP (%)</span>
                                <span class="info-box-number" id="gap-percentage">0.00%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gráficos -->
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Gráfico Consolidado</h3>
                            </div>
                            <div class="card-body">
                                <canvas id="mainChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </section>
    </div>

    <footer th:replace="~{fragments :: footer}"></footer>

</div>

<div th:replace="~{fragments :: scripts}"></div>

<script th:inline="javascript">
    $(document).ready(function() {
        const yearFilter = $('#year-filter');
        const monthFilter = $('#month-filter');
        let mainChart;

        // Preenche os meses
        const months = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
        months.forEach((month, index) => {
            monthFilter.append(`<option value="${index + 1}">${month}</option>`);
        });

        // Busca e preenche os anos
        $.get('/api/years', function(years) {
            years.forEach(year => {
                yearFilter.append(`<option value="${year}">${year}</option>`);
            });
            // Seleciona o ano atual por padrão
            const currentYear = new Date().getFullYear().toString();
            if (years.includes(currentYear)) {
                yearFilter.val(currentYear);
            }
            // Carrega os dados iniciais
            $('#filter-btn').click();
        });

        // Ação do botão de filtro
        $('#filter-btn').on('click', function() {
            const year = yearFilter.val();
            const month = monthFilter.val();
            updateDashboard(year, month);
        });

        function updateDashboard(year, month) {
            $.ajax({
                url: '/api/chart-data',
                data: { year: year, month: month },
                success: function(data) {
                    // Atualiza os Info Boxes
                    $('#total-production').text(parseFloat(data.totalProduction || 0).toFixed(2));
                    $('#total-sales').text(parseFloat(data.totalSales || 0).toFixed(2));
                    $('#total-discard').text(parseFloat(data.totalDiscard || 0).toFixed(2));
                    $('#gap-percentage').text(`${parseFloat(data.gapPercentage || 0).toFixed(2)}%`);

                    // Atualiza o gráfico
                    const chartData = {
                        labels: ['Produção Total', 'Saídas Totais', 'Vendas', 'Consumo Interno', 'Descarte'],
                        datasets: [{
                            label: 'Valores Consolidados',
                            data: [
                                data.totalProduction,
                                data.totalOutput,
                                data.totalSales,
                                data.totalInternalConsumption,
                                data.totalDiscard
                            ],
                            backgroundColor: [
                                'rgba(54, 162, 235, 0.6)',
                                'rgba(255, 99, 132, 0.6)',
                                'rgba(75, 192, 192, 0.6)',
                                'rgba(255, 206, 86, 0.6)',
                                'rgba(153, 102, 255, 0.6)'
                            ]
                        }]
                    };

                    if (mainChart) {
                        mainChart.data = chartData;
                        mainChart.update();
                    } else {
                        const ctx = document.getElementById('mainChart').getContext('2d');
                        mainChart = new Chart(ctx, {
                            type: 'bar',
                            data: chartData,
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    }
                                }
                            }
                        });
                    }
                },
                error: function() {
                    alert('Erro ao carregar os dados do dashboard.');
                }
            });
        }
    });
</script>

</body>
</html>
